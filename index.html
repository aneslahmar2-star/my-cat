<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Rouge Cats - AI Breed Identifier</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            
            background-color: #fef2f2; /* red-50 */
            /* Updated: Detailed, cute sitting cat illustration for background */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='65' r='25' fill='none' stroke='%23fee2e2' stroke-width='3'/%3E%3Ccircle cx='50' cy='40' r='18' fill='none' stroke='%23fee2e2' stroke-width='3'/%3E%3Cpath d='M38 25 L45 15 L52 25 Z' fill='%23fee2e2'/%3E%3Cpath d='M62 25 L55 15 L48 25 Z' fill='%23fee2e2'/%3E%3Ccircle cx='40' cy='85' r='5' fill='none' stroke='%23fee2e2' stroke-width='3'/%3E%3Ccircle cx='60' cy='85' r='5' fill='none' stroke='%23fee2e2' stroke-width='3'/%3E%3C/svg%3E");
            background-size: 150px 150px; /* Sizing updated for the new illustration */
            background-repeat: repeat;
        }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        /* Custom scrollbar for better aesthetics */
        .scrollable::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable::-webkit-scrollbar-thumb {
            background-color: #fca5a5; /* red-300 */
            border-radius: 3px;
        }
        .scrollable::-webkit-scrollbar-track {
            background: #fef2f2; /* red-50 */
        }
        /* Spinner CSS */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #dc2626; /* red-600 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">
                <span class="text-red-700">Le Rouge Cats</span> <span class="text-red-400">AI</span>
            </h1>
            <p class="text-xl text-gray-500">Discover your cat's secrets: breed, personality, and rarity.</p>
        </header>

        <!-- Main Application Card -->
        <div class="bg-white p-6 md:p-10 rounded-xl card-shadow grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- UPLOAD SECTION -->
            <div>
                <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.808-1.212A2 2 0 0110.778 3h2.444a2 2 0 011.664.89l.808 1.212a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    1. Upload a Photo
                </h2>

                <!-- Image Preview and Dropzone -->
                <div id="dropzone" class="border-2 border-dashed border-red-300 rounded-lg p-6 text-center cursor-pointer hover:bg-red-100 transition duration-300">
                    <img id="imagePreview" src="https://placehold.co/400x300/fecaca/dc2626?text=Cat+Photo+Preview" alt="Image Preview" class="mx-auto max-h-64 object-contain rounded-md mb-4 hidden"/>
                    <p id="dropzoneText" class="text-gray-500 font-semibold">Drag & Drop or Click to Select File (JPG, PNG)</p>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>

                <!-- Analyze Button -->
                <button id="analyzeButton" class="w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:opacity-50 flex justify-center items-center" disabled>
                    <span id="buttonText">2. Analyze My Cat!</span>
                    <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
                </button>
                <p id="errorMessage" class="text-red-500 mt-2 text-center hidden"></p>
            </div>

            <!-- RESULTS SECTION -->
            <div class="lg:col-span-1">
                <h2 class="text-2xl font-bold text-gray-700 mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.008 12.008 0 002.944 12c.045 4.757 3.393 8.724 8.257 10.153a11.99 11.99 0 001.806 0c4.864-1.429 8.212-5.396 8.257-10.153a12.008 12.008 0 00-1.414-5.056z"></path></svg>
                    3. Analysis Results
                </h2>

                <!-- Placeholder Message -->
                <div id="resultsPlaceholder" class="bg-gray-100 p-6 rounded-lg text-center h-full flex flex-col justify-center items-center">
                    <svg class="w-12 h-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 100 4m-3.5 0h7a1 1 0 011 1v7a1 1 0 01-1 1h-3.5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-3-3m0 0l-3 3"></path></svg>
                    <p class="text-gray-500">Upload an image of your feline friend to start the AI analysis.</p>
                </div>

                <!-- Result Display -->
                <div id="resultsDisplay" class="bg-white p-6 rounded-lg border border-gray-200 hidden scrollable max-h-[60vh] overflow-y-auto">
                    <p id="resultBreed" class="text-3xl font-extrabold text-red-800 mb-2"></p>
                    <div class="mb-4 flex items-center">
                        <span class="text-lg font-semibold text-gray-600 mr-3">Rarity Score:</span>
                        <div id="rarityStars" class="flex">
                            <!-- Stars will be inserted here -->
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-gray-700 mt-6 mb-2">üêæ Amazing Fact</h3>
                    <p id="resultFact" class="text-gray-600 italic bg-red-100/50 p-3 rounded-lg border border-red-200"></p>

                    <h3 class="text-xl font-bold text-gray-700 mt-6 mb-2">Description</h3>
                    <p id="resultDescription" class="text-gray-600 leading-relaxed border-l-4 border-red-400 pl-4 py-1 bg-red-50 rounded"></p>

                    <h3 class="text-xl font-bold text-gray-700 mt-6 mb-2">Key Personality Traits</h3>
                    <ul id="resultTraits" class="list-disc list-inside space-y-1 text-gray-600">
                        <!-- Traits will be inserted here -->
                    </ul>
                </div>
            </div>

        </div>

    </div>

    <!-- JavaScript for Logic and AI Integration -->
    <script type="module">
        // Global variables for Firebase API keys (provided by Canvas)
        const apiKey = "AIzaSyCtqB3vGXfP2HS_Vrwt5u7-rLdKQXn_X7Q"; // API Key will be automatically handled by the environment

        // Helper function for exponential backoff retry logic
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    if (response.status === 429) { // Rate limit error
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit exceeded, retrying in ${Math.round(delay / 1000)}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    // For other non-rate-limit errors, throw to stop retrying
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Max retries reached. Failed to fetch API.", error);
                        throw error;
                    }
                    // For network errors or other exceptions, use backoff
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Fetch failed, retrying in ${Math.round(delay / 1000)}s...`, error.message);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const dropzoneText = document.getElementById('dropzoneText');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const resultsPlaceholder = document.getElementById('resultsPlaceholder');
        const resultsDisplay = document.getElementById('resultsDisplay');

        // Result Elements
        const resultBreed = document.getElementById('resultBreed');
        const rarityStars = document.getElementById('rarityStars');
        const resultFact = document.getElementById('resultFact');
        const resultDescription = document.getElementById('resultDescription');
        const resultTraits = document.getElementById('resultTraits');

        let base64Image = null;
        let mimeType = null;

        // --- Event Listeners for File Input (Click and Drop) ---

        dropzone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', handleFileSelect);

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('bg-red-100', 'border-red-500');
        });

        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('bg-red-100', 'border-red-500');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('bg-red-100', 'border-red-500');
            const file = e.dataTransfer.files[0];
            if (file) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (!file) return;

            // Simple validation
            if (!file.type.startsWith('image/')) {
                displayError("Please select a valid image file (JPG or PNG).");
                resetState();
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                displayError("Image size must be less than 5MB.");
                resetState();
                return;
            }

            mimeType = file.type;
            errorMessage.classList.add('hidden');
            analyzeButton.disabled = false;

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                dropzoneText.classList.add('hidden');
                // Store the base64 part only
                base64Image = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        function resetState() {
            imagePreview.classList.add('hidden');
            dropzoneText.classList.remove('hidden');
            imagePreview.src = 'https://placehold.co/400x300/fecaca/dc2626?text=Cat+Photo+Preview';
            analyzeButton.disabled = true;
            resultsDisplay.classList.add('hidden');
            resultsPlaceholder.classList.remove('hidden');
        }

        function displayError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            buttonText.textContent = "2. Analyze My Cat!";
            loadingSpinner.classList.add('hidden');
            analyzeButton.disabled = false;
        }

        function setProcessing(isProcessing) {
            analyzeButton.disabled = isProcessing || !base64Image;
            loadingSpinner.classList.toggle('hidden', !isProcessing);
            buttonText.textContent = isProcessing ? "Analyzing..." : "2. Analyze My Cat!";
            errorMessage.classList.add('hidden');
        }

        // --- API CALL FUNCTION ---

        analyzeButton.addEventListener('click', async () => {
            if (!base64Image) {
                displayError("Please upload an image first.");
                return;
            }

            setProcessing(true);
            resultsPlaceholder.classList.add('hidden');
            resultsDisplay.classList.add('hidden');

            const model = 'gemini-2.5-flash-preview-09-2025';
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const systemPrompt = `You are a world-class Feline Breed Expert. Your task is to analyze the provided image of a cat and return your findings in a strict JSON format. 
            Identify the most likely cat breed. Then, based on the breed characteristics, estimate its personality traits, provide a description, assign a rarity score, and provide one truly amazing and little-known fact about that specific cat breed.
            The Rarity Score is based on how commonly the breed is found globally, where 1 is a very common breed (like a Domestic Shorthair/Tabby) and 10 is an extremely rare breed (like a Sokoke or LaPerm).
            Do not include any introductory or concluding text in your response, just the JSON object.`;

            const userQuery = "Identify the breed of this cat and provide a comprehensive analysis.";

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userQuery },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Image
                            }
                        }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "breedName": { "type": "STRING", "description": "The name of the most likely cat breed identified." },
                            "rarityScore": { "type": "INTEGER", "description": "A rarity score from 1 (common) to 10 (extremely rare)." },
                            "description": { "type": "STRING", "description": "A short, engaging paragraph describing the breed's physical characteristics and history." },
                            "amazingFact": { "type": "STRING", "description": "One truly amazing and little-known fact about this specific cat breed." },
                            "personalityTraits": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" },
                                "description": "A list of 3-5 key personality and temperament traits."
                            }
                        },
                        "required": ["breedName", "rarityScore", "description", "amazingFact", "personalityTraits"]
                    }
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!result.candidates || result.candidates.length === 0) {
                    throw new Error("API returned no content. The image might be unclear or the model failed to process it.");
                }

                const jsonText = result.candidates[0].content.parts[0].text.trim();
                const analysis = JSON.parse(jsonText);

                renderResults(analysis);

            } catch (error) {
                console.error("Analysis Failed:", error);
                displayError("The AI analysis failed. Please ensure the image is a clear, well-lit photo of a cat and try again.");
                resultsPlaceholder.classList.remove('hidden');
                resultsDisplay.classList.add('hidden');
            } finally {
                setProcessing(false);
            }
        });

        // --- Result Rendering ---

        function renderResults(analysis) {
            resultBreed.textContent = analysis.breedName || "Unknown Breed";
            resultDescription.textContent = analysis.description || "No detailed description available.";
            resultFact.textContent = analysis.amazingFact || "No amazing fact available for this cat breed.";

            // Render Rarity Stars
            const score = analysis.rarityScore > 0 ? Math.min(10, analysis.rarityScore) : 5;
            rarityStars.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const starColor = i <= score ? 'text-yellow-400' : 'text-gray-300';
                // Using SVG for high-quality, scalable stars
                const starSvg = `<svg class="w-5 h-5 ${starColor}" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.967a1 1 0 00.95.69h4.17c.969 0 1.371 1.243.588 1.81l-3.374 2.454a1 1 0 00-.364 1.118l1.287 3.967c.3.921-.755 1.688-1.538 1.118l-3.374-2.454a1 1 0 00-1.176 0l-3.374 2.454c-.783.57-1.838-.197-1.538-1.118l1.286-3.967a1 1 0 00-.364-1.118L2.404 9.4c-.783-.57-.381-1.81.588-1.81h4.17a1 1 0 00.95-.69l1.286-3.967z"></path></svg>`;
                rarityStars.insertAdjacentHTML('beforeend', starSvg);
            }

            // Render Personality Traits
            resultTraits.innerHTML = '';
            if (Array.isArray(analysis.personalityTraits)) {
                analysis.personalityTraits.forEach(trait => {
                    const li = document.createElement('li');
                    li.classList.add('font-medium', 'text-gray-700', 'pl-1');
                    li.textContent = trait;
                    resultTraits.appendChild(li);
                });
            }

            resultsDisplay.classList.remove('hidden');
            resultsPlaceholder.classList.add('hidden');
        }

        // Initialize state
        window.onload = resetState;

    </script>
</body>
</html>